#
# (c) Copyright 2014 Hewlett-Packard Development Company, L.P.
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#
#
# sample nodetype for mailbox
#
---
classes:
  - postfix::server
  - dovecot
  - mailserver
  - apache
  - apache::mod::expires
  - apache::mod::headers
  - apache::mod::info
  - apache::mod::php
  - apache::mod::proxy
  - apache::mod::proxy_http
  - apache::mod::rewrite
  - apache::mod::ssl
  - apache::mod::status
  - apache::mod::userdir
  - mysql::server
  - clamav
  - spamassassin
  - postgrey

apache::purge_vdir:    true
apache::default_vhost: false
apache::default_mods:  true
apache::mpm_module:    prefork

config::emailaliases::default_root_email: "postfixadmin@%{::domain}"

clamav::config::clamav_user: 'postfix'

#######################################################
# postfix config
#######################################################
postfix::server::inet_interfaces: "%{::ipaddress}, 127.0.0.1"
postfix::server::mysql: true
postfix::server::relayhost: ''
postfix::server::relay_domains: "proxy:mysql:/etc/postfix/mysql_relay_domains_maps.cf, lists.%{::domain}"

postfix::server::mynetworks_style: 'subnet'
postfix::server::mynetworks: '$config_directory/mynetworks'
postfix::server::mynetworklist:
  - '127.0.0.0/8'
  - '[::ffff:127.0.0.0]/104'
  - '[::1]/128'

#postfix::server::virtual_mailbox_limit_maps:  'proxy:mysql:/etc/postfix/virtual_mailbox_limit_maps.cf'
postfix::server::virtual_mailbox_base:  '/var/vmail'
postfix::server::virtual_mailbox_domains: 'proxy:mysql:/etc/postfix/mysql_virtual_domains_maps.cf'
postfix::server::virtual_mailbox_maps:  'proxy:mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf'
postfix::server::virtual_alias_maps:  'proxy:mysql:/etc/postfix/mysql_virtual_alias_maps.cf'
postfix::server::virtual_uid_maps: 'static:9990'
postfix::server::virtual_gid_maps: 'static:8'
#postfix::server::virtual_transport: 'dovecot'
# uncomment below and comment above if you want to use maildrop filter rules
postfix::server::virtual_transport: 'maildrop'
postfix::server::submission: true
postfix::server::submission_smtpd_client_restrictions: 'permit_sasl_authenticated,permit_mynetworks,reject'
postfix::server::smtpd_sasl_auth: true
postfix::server::ssl: true
postfix::server::smtpd_tls_security_level: 'may'
postfix::server::smtpd_tls_key_file:  "/etc/ssl/personal/separate/%{::fqdn}-key.pem"
postfix::server::smtpd_tls_cert_file: "/etc/ssl/personal/separate/%{::fqdn}-cert.pem"
postfix::server::smtpd_recipient_restrictions:
  - 'permit_mynetworks'
  - 'permit_sasl_authenticated'
  - 'reject_non_fqdn_hostname'
  - 'reject_non_fqdn_sender'
  - 'reject_non_fqdn_recipient'
  - 'reject_unauth_destination'
  - 'reject_unauth_pipelining'
  - 'reject_invalid_hostname'
  - 'check_policy_service inet:127.0.0.1:10023'
  - 'permit'
postfix::server::smtpd_data_restrictions:
  - 'reject_unauth_pipelining' 
  - 'reject_multi_recipient_bounce'
  - 'permit'

postfix::server::vacation_enable: true
postfix::server::vacation_user:   'postfixadmin'
postfix::server::vacation_pass:   'albatross'
postfix::server::vacation_db:     'postfixadmin'
postfix::server::vacation_smtp:   'localhost'
postfix::server::vacation_port:   '25'
postfix::server::transport_maps:
  - '# managed by puppet'
  - "autoreply.%{::fqdn} vacation:"
  - "lists.%{::domain} mailman:"
postfix::server::header_checks:
  - '/^Received:/ HOLD'

#######################################################
# dovecot config
#######################################################

dovecot::plugins:
  - solr
  - pop3d
  - mysql
  - sieve
  - managesieved

dovecot::auth_include:
  - 'system'
  - 'sql'

dovecot::ssl:      'yes'
dovecot::ssl_cert: "/etc/ssl/personal/separate/%{::fqdn}-cert.pem"
dovecot::ssl_key:  "/etc/ssl/personal/separate/%{::fqdn}-key.pem"

dovecot::auth_listener_postfix: true

dovecot::log_path:      '/var/log/dovecot/dovecot.log'
dovecot::log_timestamp: '%Y-%m-%d %H:%M:%S '
dovecot::auth_verbose:  'no'
dovecot::auth_debug:    'no'
dovecot::mail_debug:    'no'

dovecot::protocols:             'pop3 imap sieve'
dovecot::default_internal_user: 'vmail'
dovecot::mail_location:         'maildir:/var/vmail/%d/%u'
dovecot::sieve:                 '~/sieve/dovecot.sieve'
dovecot::sieve_dir:             '~/sieve'

dovecot::config_sql:          true
dovecot::config_sql_driver:   'mysql'
dovecot::config_sql_connect:  "host=/var/run/mysqld/mysqld.sock dbname=postfixadmin user=postfixadmin password=albatross"
dovecot::config_sql_pwscheme: 'MD5'
dovecot::config_sql_userq:    "SELECT '/var/vmail/%d/%n' as home, 'maildir:/var/vmail/%d/%n' as mail, 9990 AS uid, 9990 AS gid, concat('dirsize:storage=', quota) AS quota FROM mailbox WHERE username = '%u' AND active = '1'"
dovecot::config_sql_passq:    "SELECT username as user, password, '/var/vmail/%d/%n' as userdb_home, 'maildir:/var/vmail/%d/%n' as userdb_mail, 9990 as userdb_uid, 9990 as userdb_gid FROM mailbox WHERE username = '%u' AND active = '1'"

#######################################################
# mailman config
#######################################################

mailman::enable_service: true
mailman::site_pw:        'albatross'
mailman::mta:            'Postfix'
mailman::smtp_hostmame:  "%{::fqdn}"
mailman::http_hostmame:  "%{::fqdn}"

#######################################################
# mailserver config
#######################################################

mailserver::external_name: %{::domain}
mailserver::usessl:         true
mailserver::sslca:         '/etc/ssl/certs/selfca.pem'
mailserver::sslcert:        "/etc/ssl/personal/separate/%{::fqdn}-cert.pem"
mailserver::sslkey:         "/etc/ssl/personal/separate/%{::fqdn}-key.pem"
mailserver::pfdb_pass:      'albatross'
mailserver::spamd_host:     'localhost'
mailserver::spamd_user:     'spamd'
mailserver::spamd_pass:     'falcon'
mailserver::pfadminuser:    'postfixadmin'
mailserver::pfadminpass:    'chicken'

mailserver::mailwatch::db_user: 'mailwatch'
mailserver::mailwatch::db_pass: 'eagle'
mailserver::mailwatch::db_host: 'localhost'
mailserver::mailwatch::db_name: 'mailscanner'
mailserver::mailwatch::mwadmin: 'admin'
mailserver::mailwatch::mypass:  'albatross'

mailserver::roundcube::rcuser: 'roundcube'
mailserver::roundcube::rcpass: 'turkey'

# note, this needs to be a valid email addr
mailserver::listadmin: 'postfixadmin'
mailserver::listpass:  'robin'
mailserver::listmaster: 'penguin'
#######################################################
# packages config
#######################################################

packages::install:
  - 'bcrypt'
  - 'php5-mysql'
  - 'php5-curl'
  - 'php5-gd'
  - 'php5-dev'
  - 'php-pear'
  - 'php5-mcrypt'
  - 'php5-imap'
  - 'listadmin'
  - 'maildrop'
  - 'dcc-common'
  - 'dcc-client'
  - 'unrar'
  - 'mailman'
  - 'pflogsumm'
  - 'libemail-valid-perl'
  - 'libmime-tools-perl'
  - 'libmail-sender-perl'
  - 'libdbd-pg-perl'
  - 'libemail-valid-perl'
  - 'libmime-perl'
  - 'liblog-log4perl-perl'
  - 'liblog-dispatch-perl'
  - 'libgetopt-argvfile-perl'
  - 'libmime-charset-perl'
  - 'libmime-encwords-perl'
  - 'libfile-spec-perl'
  - 'libpod-simple-perl'
  - 'libtest-pod-perl'
  - 'libtest-harness-perl'
  - 'libtest-simple-perl'
  - 'libio-all-perl'
  - 'libhtml-parser-perl'
  - 'libhtml-tagset-perl'
  - 'libconvert-tnef-perl'
  - 'libcompress-raw-zlib-perl'
  - 'libconvert-binhex-perl'
  - 'libarchive-zip-perl'
  - 'libscalar-list-utils-perl'
  - 'libdbi-perl'
  - 'libdbd-sqlite3-perl'
  - 'libgetopt-long-descriptive-perl'
  - 'libfilesys-df-perl'
  - 'libmath-bigint-perl'
  - 'libnet-cidr-perl'
  - 'libdigest-md5-file-perl'
  - 'libole-storage-lite-perl'
  - 'libsys-sigaction-perl'
  - 'libsys-syslog-perl'
  - 'libio-stringy-perl'
  - 'libmailtools-perl'
  - 'libtimedate-perl'

packages::remove:
  - 'apparmor'
  - 'wireless-tools'

#######################################################
# mysql config
#######################################################

mysql::server::root_password:      'albatross'
mysql::server::manage_config_file: true
mysql::restart:                    false
mysql::service_enabled:            true
mysql::service_manage:             true
mysql::server::override_options:
  'mysqld':
    'max_allowed_packet':               '32M'
    'sort_buffer_size':                 '2M'
    'read_buffer_size':                 '128K'
    'read_rnd_buffer_size':             '256K'
    'myisam_sort_buffer_size':          '2M'
    'key_buffer_size':                  '64M'
    'thread_cache_size':                '256'
    'query_cache_type':                 '0'
    'query_cache_size':                 '0'
    'tmp_table_size':                   '268435456'
    'max_heap_table_size':              '268435456'
    'innodb_buffer_pool_size':          '500M'
    'innodb_additional_mem_pool_size':  '4M'
    'innodb_log_buffer_size':           '8M'
    'innodb_file_per_table':             true
    'table_cache':                      '256'
    'bind_address':                     '0.0.0.0'
    'max_connections':                  '250'
    'server-id':                        '1'
    'log_bin':                          '/var/log/mysql/mysql-bin.log'
    'log_slow_queries':                 '/var/log/mysql/mysql-slow.log'
    'log-queries-not-using-indexes':    true
    'long_query_time':                  '5'
    'expire_logs_days':                 '5'
    'binlog_ignore_db':                 '%mysql'
    'replicate-wild-ignore-table':      'mysql.%'
    'ssl':                              'false'
    'loose-local-infile':               '1'
