# Copyright 2013 OpenStack Foundation.
# Copyright 2013 Hewlett-Packard Development Company, L.P.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#

#<VirtualHost _default_:80>
#             ServerAdmin <%= scope.lookupvar("::jenkins_config::master::serveradmin") %>
#             ErrorLog ${APACHE_LOG_DIR}/<%= scope.lookupvar("::jenkins_config::master::vhost_name") %>-error.log
#             LogLevel warn
#             CustomLog ${APACHE_LOG_DIR}/<%= scope.lookupvar("::jenkins_config::master::vhost_name") %>-access.log combined
#             Redirect / https://<%= scope.lookupvar("::jenkins_config::master::vhost_name") %>/
#</VirtualHost>

<VirtualHost _default_:443>
             ServerName <%= scope.lookupvar("::jenkins_config::master::vhost_name") %>
             ServerAdmin <%= scope.lookupvar("::jenkins_config::master::serveradmin") %>

             ErrorLog ${APACHE_LOG_DIR}/<%= scope.lookupvar("::jenkins_config::master::vhost_name") %>-ssl-error.log

             LogLevel warn

             CustomLog ${APACHE_LOG_DIR}/<%= scope.lookupvar("::jenkins_config::master::vhost_name") %>-ssl-access.log combined

             SSLEngine on

             SSLCertificateFile      <%= scope.lookupvar("::jenkins_config::master::ssl_cert_file") %>
             SSLCertificateKeyFile   <%= scope.lookupvar("::jenkins_config::master::ssl_key_file") %>
             <% if scope.lookupvar("::jenkins_config::master::ssl_chain_file") != "" %>
               SSLCertificateChainFile <%= scope.lookupvar("::jenkins_config::master::ssl_chain_file") %>
             <% end %>

             BrowserMatch "MSIE [2-6]" \
                     nokeepalive ssl-unclean-shutdown \
                     downgrade-1.0 force-response-1.0
             # MSIE 7 and newer should be able to use keepalive
             BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

             RewriteEngine on
             RewriteCond %{HTTP_HOST} !<%= scope.lookupvar("::jenkins_config::master::vhost_name") %>
             RewriteRule ^.*$ https://<%= scope.lookupvar("::jenkins_config::master::vhost_name") %>/

             RewriteRule /zuul/status http://127.0.0.1:8001/status [P]

             ProxyPass / http://127.0.0.1:8080/ retry=0
             ProxyPassReverse / http://127.0.0.1:8080/
</VirtualHost>
